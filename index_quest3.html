<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Piscine Escape – WebXR (Quest 3 native stick)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Physique (cannon-es) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@6.1.0/dist/aframe-physics-system.min.js"></script>

  <!-- Super Hands (grabbable/draggable/stretchable) -->
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.6/dist/super-hands.min.js"></script>

  <script>
    // Déplacement basé sur l'événement 'thumbstickmoved' (Quest/Oculus Browser)
    AFRAME.registerComponent('quest3-stick-move', {
      schema: { speed: {type: 'number', default: 2.5}, camera: {type: 'selector'} },
      init: function () {
        this.input = {x: 0, y: 0};
        const left = document.querySelector('#leftHand');
        if (left) {
          left.addEventListener('thumbstickmoved', (e) => {
            this.input.x = e.detail?.x || 0;
            this.input.y = e.detail?.y || 0;
          });
        }
      },
      tick: function (t, dt) {
        const delta = dt / 1000;
        if (!delta) return;
        const rig = this.el.object3D;
        const cam = (this.data.camera || document.querySelector('#camera')).object3D;
        const forward = new THREE.Vector3(0,0,-1).applyQuaternion(cam.quaternion); forward.y = 0; forward.normalize();
        const right = new THREE.Vector3(1,0,0).applyQuaternion(cam.quaternion); right.y = 0; right.normalize();
        const move = new THREE.Vector3().addScaledVector(right, this.input.x).addScaledVector(forward, -this.input.y);
        if (move.lengthSq() > 0) { move.normalize().multiplyScalar(this.data.speed * delta); rig.position.add(move); }
      }
    });
  </script>

  <style>
    #hint{position:fixed;left:12px;top:12px;z-index:9999;background:rgba(0,0,0,.55);color:#fff;
      font-family:system-ui,sans-serif;padding:10px 12px;border-radius:8px;line-height:1.4;font-size:13px}
  </style>
</head>
<body>
  <div id="hint">
    Quest 3 : cliquez <b>Enter VR</b>, puis utilisez le <b>stick gauche</b> pour marcher (mouvement libre).<br/>
    <b>Trigger</b> = téléportation (arc bleu). <b>Grip</b> = saisir les objets.
  </div>

  <a-scene>
    <!-- Ciel & lumières -->
    <a-sky color="#87CEFA"></a-sky>
    <a-entity light="type: ambient; intensity: 0.45"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="0 6 3"></a-entity>

    <!-- Sol large -->
    <a-plane class="teleportable" rotation="-90 0 0" width="40" height="40" color="#C2B280"></a-plane>

    <!-- Piscine + murs (reculés) -->
    <a-box position="0 0.25 -5" depth="8" height="0.5" width="12"
           color="#1E90FF" material="opacity:0.6; transparent:true"></a-box>
    <a-box position="0 0.6 1" depth="0.5" height="1.2" width="14" color="#eaeaea"></a-box>
    <a-box position="0 0.6 -11" depth="0.5" height="1.2" width="14" color="#eaeaea"></a-box>
    <a-box position="-7 0.6 -5" depth="12" height="1.2" width="0.5" color="#eaeaea"></a-box>
    <a-box position="7 0.6 -5" depth="12" height="1.2" width="0.5" color="#eaeaea"></a-box>

    <!-- Objets à saisir -->
    <a-box position="-1 1.2 -3.5" depth="0.4" height="0.4" width="0.4" color="#ff6b6b"></a-box>
    <a-sphere position="1 1.6 -4.2" radius="0.25" color="#ffd93d"></a-sphere>
    <a-cylinder position="0 1.4 -6" radius="0.2" height="0.5" color="#6bcB77"></a-cylinder>

    <!-- RIG joueur (centre) : déplacement via quest3-stick-move -->
    <a-entity id="rig" position="0 0 -3" quest3-stick-move="speed:2.5; camera:#camera">
      <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>

      <!-- Mains VR : téléportation (built-in A-Frame 'teleport-controls') + visuels lowPoly -->
      <a-entity id="leftHand"
        hand-controls="hand: left; handModelStyle: lowPoly; color:#4fc3f7"
        teleport-controls="cameraRig:#rig; teleportOrigin:#camera; button: trigger; collisionEntities:.teleportable; enabled:true"></a-entity>

      <a-entity id="rightHand"
        hand-controls="hand: right; handModelStyle: lowPoly; color:#ffab40"
        teleport-controls="cameraRig:#rig; teleportOrigin:#camera; button: trigger; collisionEntities:.teleportable; enabled:true"></a-entity>
    </a-entity>
  </a-scene>
</body>
</html>
