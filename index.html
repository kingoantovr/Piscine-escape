<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Piscine Escape – WebXR (VR thumbstick fix)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Physique (cannon-es) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@6.1.0/dist/aframe-physics-system.min.js"></script>

  <!-- Super Hands (grabbable/draggable/stretchable) -->
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.6/dist/super-hands.min.js"></script>

  <!-- Movement controls (WASD/gamepad/touch fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.7.0/dist/aframe-extras.min.js"></script>

  <!-- Explicit VR joystick support (Quest/Rift/Pico thumbsticks) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-joystick-controls@3.3.0/dist/aframe-joystick-controls.min.js"></script>

  <script>
    // Simple toggle helpers
    function useTeleport() {
      const rig = document.querySelector('#rig');
      rig.setAttribute('movement-controls', 'enabled: false');
      rig.setAttribute('joystick-controls', 'enabled: false');
      document.querySelectorAll('.tpctrl')
        .forEach(el => el.setAttribute('teleport-controls', 'enabled: true'));
      document.querySelector('#modeLabel').textContent = 'Mode: Téléportation';
    }
    function useSmooth() {
      const rig = document.querySelector('#rig');
      rig.setAttribute('movement-controls', 'enabled: true');
      rig.setAttribute('joystick-controls', 'enabled: true');
      document.querySelectorAll('.tpctrl')
        .forEach(el => el.setAttribute('teleport-controls', 'enabled: false'));
      document.querySelector('#modeLabel').textContent = 'Mode: Mouvement libre (stick gauche)';
    }
    document.addEventListener('DOMContentLoaded', () => useSmooth());
  </script>

  <style>
    #ui{position:fixed;left:12px;top:12px;z-index:9999;background:rgba(0,0,0,.55);color:#fff;
        font-family:system-ui,sans-serif;padding:10px 12px;border-radius:8px;line-height:1.4}
    #ui button{margin-right:6px}
  </style>
</head>
<body>
  <div id="ui">
    <div id="modeLabel">Mode: …</div>
    <button onclick="useTeleport()">Téléportation</button>
    <button onclick="useSmooth()">Mouvement libre</button>
    <div style="margin-top:6px;font-size:12px;opacity:.9">
      VR : utilisez le <b>stick gauche</b> pour avancer / reculer / strafe. <br/>
      PC : ZQSD/WASD + souris. <br/>
      Astuce : appuyez sur <b>Enter VR</b> pour activer les sticks (sécurité navigateur).
    </div>
  </div>

  <a-scene physics="debug: false">
    <!-- Lumières & ciel -->
    <a-sky color="#87CEFA"></a-sky>
    <a-entity light="type: ambient; intensity: 0.45"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="0 6 3"></a-entity>

    <!-- Sol (statique) + zone téléportable -->
    <a-plane class="teleportable" rotation="-90 0 0" width="26" height="26"
             color="#C2B280" static-body></a-plane>

    <!-- Bassin “piscine” -->
    <a-box position="0 0.25 -5" depth="8" height="0.5" width="12"
           color="#1E90FF" material="opacity:0.6; transparent:true"></a-box>
    <!-- Murets de piscine (statique) -->
    <a-box position="0 0.6 -1" depth="0.5" height="1.2" width="12" color="#eaeaea" static-body></a-box>
    <a-box position="0 0.6 -9" depth="0.5" height="1.2" width="12" color="#eaeaea" static-body></a-box>
    <a-box position="-6 0.6 -5" depth="8" height="1.2" width="0.5" color="#eaeaea" static-body></a-box>
    <a-box position="6 0.6 -5" depth="8" height="1.2" width="0.5" color="#eaeaea" static-body></a-box>

    <!-- Quelques objets à attraper -->
    <a-box position="-1 1.2 -3.5" depth="0.4" height="0.4" width="0.4" color="#ff6b6b"
           class="grabbable" dynamic-body></a-box>
    <a-sphere position="1 1.6 -4.2" radius="0.25" color="#ffd93d"
              class="grabbable" dynamic-body></a-sphere>
    <a-cylinder position="0 1.4 -6" radius="0.2" height="0.5" color="#6bcB77"
                class="grabbable" dynamic-body></a-cylinder>

    <!-- RIG joueur -->
    <!-- movement-controls: fallback (WASD/gamepad). joystick-controls: for VR thumbsticks explicitly. -->
    <a-entity id="rig" movement-controls="fly:false; speed:0.25"
              joystick-controls="enabled:true; joystick:left; rotation:false; debug:false">
      <!-- Caméra -->
      <a-entity id="camera" camera look-controls position="0 1.6 2"></a-entity>

      <!-- Contrôleur gauche : téléport + super-hands -->
      <a-entity class="tpctrl"
                hand-controls="hand: left; handModelStyle: lowPoly; color: #4fc3f7"
                teleport-controls="cameraRig:#rig; teleportOrigin:#camera; button: trigger; collisionEntities:.teleportable; enabled:false"
                super-hands sphere-collider="objects:.grabbable"></a-entity>

      <!-- Contrôleur droit : téléport + super-hands -->
      <a-entity class="tpctrl"
                hand-controls="hand: right; handModelStyle: lowPoly; color: #ffab40"
                teleport-controls="cameraRig:#rig; teleportOrigin:#camera; button: trigger; collisionEntities:.teleportable; enabled:false"
                super-hands sphere-collider="objects:.grabbable"></a-entity>
    </a-entity>

    <!-- Petites instructions in-world -->
    <a-text value="Piscine Escape • Stick GAUCHE = marcher • Grip = saisir • Trigger = téléporter (si mode TP)"
            position="-2 2 -2" width="6" color="#111"></a-text>
  </a-scene>
</body>
</html>
